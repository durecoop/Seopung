<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>공지사항 관리 | 서풍 관리자</title>
    <meta name="robots" content="noindex, nofollow">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">

    <!-- Toast UI Editor -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
</head>
<body class="admin-page">
    <!-- Admin Sidebar -->
    <aside class="admin-sidebar">
        <div class="admin-sidebar__header">
            <img src="../logo_transparent.png" alt="서풍" class="admin-sidebar__logo">
            <span>서풍 관리자</span>
        </div>

        <nav class="admin-nav">
            <a href="dashboard.html" class="admin-nav__item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                </svg>
                <span>대시보드</span>
            </a>
            <a href="notices.html" class="admin-nav__item admin-nav__item--active">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 17H2a3 3 0 0 0 3-3V9a7 7 0 0 1 14 0v5a3 3 0 0 0 3 3zm-8.27 4a2 2 0 0 1-3.46 0"/>
                </svg>
                <span>공지사항</span>
            </a>
            <a href="resources-manage.html" class="admin-nav__item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                <span>자료실</span>
            </a>
            <a href="media.html" class="admin-nav__item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21 15 16 10 5 21"/>
                </svg>
                <span>미디어</span>
            </a>
            <a href="inquiries.html" class="admin-nav__item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                <span>제품 문의</span>
            </a>
            <a href="quotes.html" class="admin-nav__item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                <span>견적 요청</span>
            </a>
        </nav>

        <div class="admin-sidebar__footer">
            <a href="../index.html" class="admin-sidebar__link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                    <polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/>
                </svg>
                <span>홈페이지 보기</span>
            </a>
            <button class="admin-sidebar__logout" onclick="logout()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                <span>로그아웃</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <header class="admin-header">
            <div class="admin-header__title">
                <h1>공지사항 관리</h1>
                <p>공지사항을 등록하고 관리하세요</p>
            </div>
            <div class="admin-header__user">
                <span id="currentUser">관리자</span>
            </div>
        </header>

        <div class="admin-content">
            <!-- 작성 버튼 -->
            <div class="admin-card" style="margin-bottom: 1.5rem;">
                <div class="admin-card__content" style="padding: 1rem 1.5rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <button onclick="openWriteModal()" class="btn btn--primary" style="padding: 0.5rem 1rem;">
                            + 공지사항 작성
                        </button>
                        <span style="margin-left: auto; font-size: 0.875rem; color: var(--text-light);">
                            총 <strong id="totalCount">0</strong>건
                        </span>
                        <button onclick="loadNotices()" class="btn btn--outline" style="padding: 0.5rem 1rem;">새로고침</button>
                    </div>
                </div>
            </div>

            <!-- 공지사항 목록 -->
            <div class="admin-card">
                <div class="admin-card__content" style="padding: 0;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th style="width: 60px;">구분</th>
                                <th>제목</th>
                                <th style="width: 100px;">카테고리</th>
                                <th style="width: 100px;">등록일</th>
                                <th style="width: 60px;">조회</th>
                                <th style="width: 120px;">관리</th>
                            </tr>
                        </thead>
                        <tbody id="noticesList">
                            <tr><td colspan="6" style="text-align: center; padding: 3rem;">로딩 중...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- 작성/수정 모달 -->
    <div id="writeModal" class="admin-modal" style="display: none;">
        <div class="admin-modal__content" style="max-width: 900px;">
            <div class="admin-modal__header">
                <h3 id="modalTitle">공지사항 작성</h3>
                <button class="admin-modal__close" onclick="closeWriteModal()">&times;</button>
            </div>
            <div class="admin-modal__body">
                <form id="noticeForm">
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">제목 *</label>
                        <input type="text" id="noticeTitle" class="form-group__input" placeholder="공지사항 제목" required>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="flex: 1;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">카테고리</label>
                            <select id="noticeCategory" class="admin-select" style="width: 100%;">
                                <option value="일반공지">일반공지</option>
                                <option value="휴무안내">휴무안내</option>
                                <option value="제품안내">제품안내</option>
                                <option value="이벤트">이벤트</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">상단고정</label>
                            <select id="noticePinned" class="admin-select" style="width: 100%;">
                                <option value="false">일반</option>
                                <option value="true">상단고정</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">내용 *</label>
                        <div id="editor"></div>
                    </div>
                </form>
            </div>
            <div class="admin-modal__footer">
                <button class="btn btn--primary" onclick="saveNotice()">저장</button>
                <button class="btn btn--outline" onclick="closeWriteModal()" style="color: var(--text-body);">취소</button>
            </div>
        </div>
    </div>

    <!-- 상세보기 모달 -->
    <div id="detailModal" class="admin-modal" style="display: none;">
        <div class="admin-modal__content" style="max-width: 800px;">
            <div class="admin-modal__header">
                <h3 id="detailTitle">공지사항</h3>
                <button class="admin-modal__close" onclick="closeDetailModal()">&times;</button>
            </div>
            <div class="admin-modal__body" id="detailBody"></div>
            <div class="admin-modal__footer">
                <button class="btn btn--primary" onclick="editCurrentNotice()">수정</button>
                <button class="btn btn--outline" onclick="closeDetailModal()" style="color: var(--text-body);">닫기</button>
            </div>
        </div>
    </div>

    <style>
        .admin-select { padding: 0.5rem 1rem; border: 1px solid var(--border-light); border-radius: 0.375rem; font-size: 0.875rem; background: #fff; }
        .admin-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .admin-modal__content { background: #fff; border-radius: 0.75rem; width: 100%; max-height: 95vh; overflow: hidden; display: flex; flex-direction: column; }
        .admin-modal__header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border-light); }
        .admin-modal__header h3 { font-size: 1.125rem; font-weight: 600; }
        .admin-modal__close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
        .admin-modal__body { padding: 1.5rem; overflow-y: auto; flex: 1; }
        .admin-modal__footer { display: flex; gap: 0.75rem; padding: 1rem 1.5rem; border-top: 1px solid var(--border-light); justify-content: flex-end; }
        .admin-table tbody tr { cursor: pointer; transition: background 0.2s; }
        .admin-table tbody tr:hover { background: var(--bg-light); }
        .pinned-badge { background: #ef4444; color: #fff; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .detail-content { background: var(--bg-light); padding: 1.5rem; border-radius: 0.5rem; line-height: 1.8; }
        .detail-content img { max-width: 100%; height: auto; }
        .detail-content p { margin-bottom: 1rem; }
        .detail-content ul, .detail-content ol { margin-bottom: 1rem; padding-left: 1.5rem; }
        .detail-meta { display: flex; gap: 1.5rem; margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-light); }

        /* Toast UI Editor 스타일 조정 */
        .toastui-editor-defaultUI { border: 1px solid var(--border-light); border-radius: 0.5rem; }
        .toastui-editor-defaultUI-toolbar { border-radius: 0.5rem 0.5rem 0 0; }
    </style>

    <!-- Toast UI Editor -->
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, addDoc, updateDoc, deleteDoc, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCnMM7eMXjZgjP-dovTJ-cfH7iO5RWQnno",
            authDomain: "seopung-website.firebaseapp.com",
            projectId: "seopung-website",
            storageBucket: "seopung-website.firebasestorage.app",
            messagingSenderId: "563395096680",
            appId: "1:563395096680:web:8f363c42f6833f65628bdd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let noticesData = [];
        let currentNoticeId = null;
        let isEditMode = false;
        let editor = null;

        // Toast UI Editor 초기화
        function initEditor() {
            if (editor) {
                editor.destroy();
            }
            editor = new toastui.Editor({
                el: document.querySelector('#editor'),
                height: '400px',
                initialEditType: 'wysiwyg',
                previewStyle: 'vertical',
                language: 'ko-KR',
                placeholder: '공지사항 내용을 입력하세요...',
                toolbarItems: [
                    ['heading', 'bold', 'italic', 'strike'],
                    ['hr', 'quote'],
                    ['ul', 'ol', 'task'],
                    ['table', 'link'],
                    ['code', 'codeblock'],
                    ['scrollSync']
                ],
                hooks: {
                    addImageBlobHook: (blob, callback) => {
                        // 이미지 업로드 시 알림
                        alert('이미지 업로드는 외부 이미지 URL을 사용해주세요.\n\n1. 이미지를 imgbb.com 등에 업로드\n2. 이미지 URL을 복사\n3. 에디터에서 이미지 삽입 → URL 입력');
                        return false;
                    }
                }
            });
        }

        function formatDate(timestamp) {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return `${date.getFullYear()}.${String(date.getMonth()+1).padStart(2,'0')}.${String(date.getDate()).padStart(2,'0')}`;
        }

        // 공지사항 목록 로드
        window.loadNotices = async function() {
            const tbody = document.getElementById('noticesList');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">로딩 중...</td></tr>';

            try {
                const q = query(collection(db, "notices"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                noticesData = [];
                querySnapshot.forEach((doc) => {
                    noticesData.push({ id: doc.id, ...doc.data() });
                });

                // 고정 공지를 상단으로
                noticesData.sort((a, b) => {
                    if (a.pinned && !b.pinned) return -1;
                    if (!a.pinned && b.pinned) return 1;
                    return 0;
                });

                document.getElementById('totalCount').textContent = noticesData.length;

                if (noticesData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-light);">등록된 공지사항이 없습니다.</td></tr>';
                    return;
                }

                tbody.innerHTML = noticesData.map((notice, idx) => `
                    <tr onclick="openDetail('${notice.id}')">
                        <td>${notice.pinned ? '<span class="pinned-badge">공지</span>' : (noticesData.length - idx)}</td>
                        <td><strong>${notice.title || '-'}</strong></td>
                        <td>${notice.category || '일반공지'}</td>
                        <td>${formatDate(notice.createdAt)}</td>
                        <td>${notice.views || 0}</td>
                        <td>
                            <button class="btn btn--outline" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin-right: 0.25rem;" onclick="event.stopPropagation(); editNotice('${notice.id}')">수정</button>
                            <button class="btn btn--outline" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="event.stopPropagation(); deleteNotice('${notice.id}')">삭제</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error("Error loading notices:", error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #ef4444;">데이터를 불러올 수 없습니다.</td></tr>';
            }
        };

        // 작성 모달 열기
        window.openWriteModal = function() {
            isEditMode = false;
            currentNoticeId = null;
            document.getElementById('modalTitle').textContent = '공지사항 작성';
            document.getElementById('noticeTitle').value = '';
            document.getElementById('noticeCategory').value = '일반공지';
            document.getElementById('noticePinned').value = 'false';
            document.getElementById('writeModal').style.display = 'flex';

            setTimeout(() => {
                initEditor();
                editor.setHTML('');
            }, 100);
        };

        window.closeWriteModal = function() {
            document.getElementById('writeModal').style.display = 'none';
        };

        // 저장
        window.saveNotice = async function() {
            const title = document.getElementById('noticeTitle').value.trim();
            const content = editor.getHTML();
            const category = document.getElementById('noticeCategory').value;
            const pinned = document.getElementById('noticePinned').value === 'true';

            if (!title) {
                alert('제목을 입력해주세요.');
                return;
            }

            if (!content || content === '<p><br></p>') {
                alert('내용을 입력해주세요.');
                return;
            }

            try {
                if (isEditMode && currentNoticeId) {
                    await updateDoc(doc(db, "notices", currentNoticeId), {
                        title, content, category, pinned, updatedAt: Timestamp.now()
                    });
                    alert('공지사항이 수정되었습니다.');
                } else {
                    await addDoc(collection(db, "notices"), {
                        title, content, category, pinned,
                        views: 0,
                        createdAt: Timestamp.now()
                    });
                    alert('공지사항이 등록되었습니다.');
                }
                closeWriteModal();
                loadNotices();
            } catch (error) {
                console.error("Error saving notice:", error);
                alert('저장에 실패했습니다.');
            }
        };

        // 수정 모드
        window.editNotice = function(id) {
            const notice = noticesData.find(n => n.id === id);
            if (!notice) return;

            isEditMode = true;
            currentNoticeId = id;
            document.getElementById('modalTitle').textContent = '공지사항 수정';
            document.getElementById('noticeTitle').value = notice.title || '';
            document.getElementById('noticeCategory').value = notice.category || '일반공지';
            document.getElementById('noticePinned').value = notice.pinned ? 'true' : 'false';
            document.getElementById('writeModal').style.display = 'flex';

            setTimeout(() => {
                initEditor();
                editor.setHTML(notice.content || '');
            }, 100);
        };

        // 삭제
        window.deleteNotice = async function(id) {
            if (!confirm('정말 삭제하시겠습니까?')) return;
            try {
                await deleteDoc(doc(db, "notices", id));
                loadNotices();
            } catch (error) {
                alert('삭제에 실패했습니다.');
            }
        };

        // 상세보기
        window.openDetail = function(id) {
            const notice = noticesData.find(n => n.id === id);
            if (!notice) return;

            currentNoticeId = id;
            document.getElementById('detailTitle').textContent = notice.title;
            document.getElementById('detailBody').innerHTML = `
                <div class="detail-meta">
                    <span>카테고리: ${notice.category || '일반공지'}</span>
                    <span>등록일: ${formatDate(notice.createdAt)}</span>
                    <span>조회수: ${notice.views || 0}</span>
                    ${notice.pinned ? '<span style="color: #ef4444;">상단고정</span>' : ''}
                </div>
                <div class="detail-content">${notice.content || ''}</div>
            `;
            document.getElementById('detailModal').style.display = 'flex';
        };

        window.closeDetailModal = function() {
            document.getElementById('detailModal').style.display = 'none';
        };

        window.editCurrentNotice = function() {
            closeDetailModal();
            editNotice(currentNoticeId);
        };

        // 로그인 체크
        if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
            window.location.href = 'index.html';
        }
        document.getElementById('currentUser').textContent = sessionStorage.getItem('adminUser') || '관리자';

        window.logout = function() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        };

        // 모달 외부 클릭
        document.getElementById('writeModal').addEventListener('click', function(e) {
            if (e.target === this) closeWriteModal();
        });
        document.getElementById('detailModal').addEventListener('click', function(e) {
            if (e.target === this) closeDetailModal();
        });

        // 초기 로드
        loadNotices();
    </script>
</body>
</html>
