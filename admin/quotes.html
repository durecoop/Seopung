<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>견적 요청 관리 | 서풍 관리자</title>
    <meta name="robots" content="noindex, nofollow">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>
<body class="admin-page">
    <!-- Admin Sidebar -->
    <aside class="admin-sidebar">
        <div class="admin-sidebar__header">
            <img src="../logo_transparent.png" alt="서풍" class="admin-sidebar__logo">
            <span>서풍 관리자</span>
        </div>

        <nav class="admin-nav">
            <a href="dashboard.html" class="admin-nav__item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                </svg>
                <span>대시보드</span>
            </a>
            <a href="inquiries.html" class="admin-nav__item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                <span>제품 문의</span>
            </a>
            <a href="quotes.html" class="admin-nav__item admin-nav__item--active">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                <span>견적 요청</span>
            </a>
            <a href="account-info.html" class="admin-nav__item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                <span>접속 정보</span>
            </a>
        </nav>

        <div class="admin-sidebar__footer">
            <a href="../index.html" class="admin-sidebar__link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                    <polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/>
                </svg>
                <span>홈페이지 보기</span>
            </a>
            <button class="admin-sidebar__logout" onclick="logout()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                <span>로그아웃</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <header class="admin-header">
            <div class="admin-header__title">
                <h1>견적 요청 관리</h1>
                <p>고객 견적 요청을 확인하고 처리하세요</p>
            </div>
            <div class="admin-header__user">
                <span id="currentUser">관리자</span>
            </div>
        </header>

        <div class="admin-content">
            <!-- 필터 -->
            <div class="admin-card" style="margin-bottom: 1.5rem;">
                <div class="admin-card__content" style="padding: 1rem 1.5rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <select id="statusFilter" class="admin-select" onchange="loadQuotes()">
                            <option value="all">전체 상태</option>
                            <option value="pending">대기</option>
                            <option value="progress">검토중</option>
                            <option value="completed">완료</option>
                        </select>
                        <span style="margin-left: auto; font-size: 0.875rem; color: var(--text-light);">
                            총 <strong id="totalCount">0</strong>건
                        </span>
                        <button onclick="loadQuotes()" class="btn btn--outline" style="padding: 0.5rem 1rem;">새로고침</button>
                    </div>
                </div>
            </div>

            <!-- 견적 목록 -->
            <div class="admin-card">
                <div class="admin-card__content" style="padding: 0;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>회사명 / 담당자</th>
                                <th>희망제품</th>
                                <th>예상물량</th>
                                <th style="width: 100px;">등록일</th>
                                <th style="width: 80px;">상태</th>
                                <th style="width: 120px;">관리</th>
                            </tr>
                        </thead>
                        <tbody id="quotesList">
                            <tr><td colspan="6" style="text-align: center; padding: 3rem;">로딩 중...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- 상세보기 모달 -->
    <div id="detailModal" class="admin-modal" style="display: none;">
        <div class="admin-modal__content">
            <div class="admin-modal__header">
                <h3 id="modalTitle">견적 요청 상세</h3>
                <button class="admin-modal__close" onclick="closeModal()">&times;</button>
            </div>
            <div class="admin-modal__body" id="modalBody"></div>
            <div class="admin-modal__footer">
                <select id="modalStatus" class="admin-select">
                    <option value="pending">대기</option>
                    <option value="progress">검토중</option>
                    <option value="completed">완료</option>
                </select>
                <button class="btn btn--primary" onclick="updateStatus()">상태 변경</button>
                <button class="btn btn--outline" onclick="closeModal()" style="color: var(--text-body);">닫기</button>
            </div>
        </div>
    </div>

    <style>
        .admin-select { padding: 0.5rem 1rem; border: 1px solid var(--border-light); border-radius: 0.375rem; font-size: 0.875rem; background: #fff; }
        .admin-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .admin-modal__content { background: #fff; border-radius: 0.75rem; width: 90%; max-width: 600px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; }
        .admin-modal__header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border-light); }
        .admin-modal__header h3 { font-size: 1.125rem; font-weight: 600; }
        .admin-modal__close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
        .admin-modal__body { padding: 1.5rem; overflow-y: auto; flex: 1; }
        .admin-modal__footer { display: flex; gap: 0.75rem; padding: 1rem 1.5rem; border-top: 1px solid var(--border-light); justify-content: flex-end; }
        .detail-row { display: flex; margin-bottom: 1rem; font-size: 0.9375rem; }
        .detail-label { width: 100px; color: var(--text-light); flex-shrink: 0; }
        .detail-value { flex: 1; color: var(--text-dark); }
        .detail-content { background: var(--bg-light); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; white-space: pre-wrap; line-height: 1.6; }
        .unread-row { background: #fef3c7; }
        .admin-table tbody tr { cursor: pointer; transition: background 0.2s; }
        .admin-table tbody tr:hover { background: var(--bg-light); }
        .product-tag { display: inline-block; background: var(--primary); color: #fff; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; margin: 0.125rem; }
    </style>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyDemo-REPLACE-WITH-YOUR-KEY",
            authDomain: "seopung-demo.firebaseapp.com",
            projectId: "seopung-demo",
            storageBucket: "seopung-demo.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentQuoteId = null;
        let quotesData = [];

        const productNames = { 'mackerel': '간고등어', 'squid': '오징어', 'seabream': '참돔', 'salmon': '연어', 'flatfish': '광어/우럭', 'other': '기타' };
        const statusMap = { 'pending': '대기', 'progress': '검토중', 'completed': '완료' };
        const statusClassMap = { 'pending': 'admin-badge--pending', 'progress': 'admin-badge--progress', 'completed': 'admin-badge--completed' };

        function formatDate(timestamp) {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return `${date.getFullYear()}.${String(date.getMonth()+1).padStart(2,'0')}.${String(date.getDate()).padStart(2,'0')}`;
        }

        function getProductNames(products) {
            if (!products || !Array.isArray(products)) return '-';
            return products.map(p => productNames[p] || p).join(', ');
        }

        // 견적 목록 로드
        window.loadQuotes = async function() {
            const tbody = document.getElementById('quotesList');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">로딩 중...</td></tr>';

            try {
                const statusFilter = document.getElementById('statusFilter').value;
                let q = query(collection(db, "quotes"), orderBy("createdAt", "desc"));

                const querySnapshot = await getDocs(q);
                quotesData = [];
                querySnapshot.forEach((doc) => {
                    quotesData.push({ id: doc.id, ...doc.data() });
                });

                // 필터링
                let filtered = quotesData;
                if (statusFilter !== 'all') {
                    filtered = filtered.filter(q => q.status === statusFilter);
                }

                document.getElementById('totalCount').textContent = filtered.length;

                if (filtered.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-light);">견적 요청 내역이 없습니다.</td></tr>';
                    return;
                }

                tbody.innerHTML = filtered.map(quote => `
                    <tr class="${!quote.read ? 'unread-row' : ''}" onclick="openDetail('${quote.id}')">
                        <td><strong>${quote.company || '-'}</strong><br><small>${quote.name || '-'}</small></td>
                        <td style="max-width: 200px;">${getProductNames(quote.products)}</td>
                        <td>${quote.quantity || '-'}</td>
                        <td>${formatDate(quote.createdAt)}</td>
                        <td><span class="admin-badge ${statusClassMap[quote.status] || 'admin-badge--pending'}">${statusMap[quote.status] || quote.status}</span></td>
                        <td>
                            <button class="btn btn--outline" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="event.stopPropagation(); deleteQuote('${quote.id}')">삭제</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error("Error loading quotes:", error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #ef4444;">데이터를 불러올 수 없습니다. Firebase 설정을 확인하세요.</td></tr>';
            }
        };

        // 상세보기
        window.openDetail = async function(id) {
            const quote = quotesData.find(q => q.id === id);
            if (!quote) return;

            currentQuoteId = id;

            // 읽음 처리
            if (!quote.read) {
                try {
                    await updateDoc(doc(db, "quotes", id), { read: true });
                    quote.read = true;
                    loadQuotes();
                } catch (e) { console.error(e); }
            }

            document.getElementById('modalTitle').textContent = `${quote.company || ''} 견적 요청`;
            document.getElementById('modalStatus').value = quote.status || 'pending';

            const productsHtml = quote.products ? quote.products.map(p => `<span class="product-tag">${productNames[p] || p}</span>`).join('') : '-';

            document.getElementById('modalBody').innerHTML = `
                <div class="detail-row"><span class="detail-label">회사명</span><span class="detail-value">${quote.company || '-'}</span></div>
                <div class="detail-row"><span class="detail-label">담당자</span><span class="detail-value">${quote.name || '-'}${quote.position ? ` (${quote.position})` : ''}</span></div>
                <div class="detail-row"><span class="detail-label">연락처</span><span class="detail-value"><a href="tel:${quote.phone}">${quote.phone || '-'}</a></span></div>
                <div class="detail-row"><span class="detail-label">이메일</span><span class="detail-value"><a href="mailto:${quote.email}">${quote.email || '-'}</a></span></div>
                <div class="detail-row"><span class="detail-label">희망제품</span><span class="detail-value">${productsHtml}</span></div>
                <div class="detail-row"><span class="detail-label">거래유형</span><span class="detail-value">${quote.trade_type || '-'}</span></div>
                <div class="detail-row"><span class="detail-label">예상물량</span><span class="detail-value">${quote.quantity || '-'}</span></div>
                <div class="detail-row"><span class="detail-label">납품희망일</span><span class="detail-value">${quote.delivery_date || '-'}</span></div>
                <div class="detail-row"><span class="detail-label">배송지</span><span class="detail-value">${quote.address || '-'}</span></div>
                <div class="detail-row"><span class="detail-label">등록일</span><span class="detail-value">${formatDate(quote.createdAt)}</span></div>
                ${quote.content ? `<div class="detail-content">${quote.content}</div>` : ''}
            `;

            document.getElementById('detailModal').style.display = 'flex';
        };

        window.closeModal = function() {
            document.getElementById('detailModal').style.display = 'none';
            currentQuoteId = null;
        };

        window.updateStatus = async function() {
            if (!currentQuoteId) return;
            const newStatus = document.getElementById('modalStatus').value;
            try {
                await updateDoc(doc(db, "quotes", currentQuoteId), { status: newStatus });
                alert('상태가 변경되었습니다.');
                closeModal();
                loadQuotes();
            } catch (error) {
                alert('상태 변경에 실패했습니다.');
            }
        };

        window.deleteQuote = async function(id) {
            if (!confirm('정말 삭제하시겠습니까?')) return;
            try {
                await deleteDoc(doc(db, "quotes", id));
                loadQuotes();
            } catch (error) {
                alert('삭제에 실패했습니다.');
            }
        };

        // 로그인 체크
        if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
            window.location.href = 'index.html';
        }
        document.getElementById('currentUser').textContent = sessionStorage.getItem('adminUser') || '관리자';

        window.logout = function() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        };

        document.getElementById('detailModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // 초기 로드
        loadQuotes();
    </script>
</body>
</html>
