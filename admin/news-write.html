<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>뉴스 작성 | 서풍 관리자</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
</head>
<body class="admin-page">
    <aside class="admin-sidebar">
        <div class="admin-sidebar__header">
            <img src="../logo_transparent.png" alt="서풍" class="admin-sidebar__logo">
            <span>서풍 관리자</span>
        </div>
        <nav class="admin-nav">
            <a href="dashboard.html" class="admin-nav__item"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg><span>대시보드</span></a>
            <a href="notices.html" class="admin-nav__item"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 17H2a3 3 0 0 0 3-3V9a7 7 0 0 1 14 0v5a3 3 0 0 0 3 3zm-8.27 4a2 2 0 0 1-3.46 0"/></svg><span>공지사항</span></a>
            <a href="news-manage.html" class="admin-nav__item admin-nav__item--active"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/></svg><span>뉴스/보도자료</span></a>
            <a href="resources-manage.html" class="admin-nav__item"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><span>자료실</span></a>
            <a href="faq-manage.html" class="admin-nav__item"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><span>FAQ</span></a>
            <a href="careers-manage.html" class="admin-nav__item"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg><span>채용정보</span></a>
            <a href="inquiries.html" class="admin-nav__item"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><span>제품 문의</span></a>
            <a href="quotes.html" class="admin-nav__item"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><span>견적 요청</span></a>
        </nav>
        <div class="admin-sidebar__footer">
            <a href="../index.html" class="admin-sidebar__link"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg><span>홈페이지 보기</span></a>
            <button class="admin-sidebar__logout" onclick="logout()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg><span>로그아웃</span></button>
        </div>
    </aside>

    <main class="admin-main">
        <header class="admin-header">
            <div class="admin-header__title">
                <h1 id="pageTitle">뉴스 작성</h1>
                <p>뉴스/보도자료를 작성하세요</p>
            </div>
            <div class="admin-header__actions">
                <a href="news-manage.html" class="btn btn--outline">← 목록으로</a>
            </div>
        </header>

        <div class="admin-content">
            <form id="newsForm" class="write-form">
                <div class="write-form__section">
                    <label class="write-form__label">제목 <span class="required">*</span></label>
                    <input type="text" id="newsTitle" class="write-form__input" placeholder="뉴스 제목을 입력하세요" required>
                </div>

                <div class="write-form__row">
                    <div class="write-form__section write-form__section--half">
                        <label class="write-form__label">카테고리</label>
                        <select id="newsCategory" class="write-form__select">
                            <option value="언론보도">언론보도</option>
                            <option value="수상">수상</option>
                            <option value="인증">인증</option>
                            <option value="기타">기타</option>
                        </select>
                    </div>
                    <div class="write-form__section write-form__section--half">
                        <label class="write-form__label">출처/언론사</label>
                        <input type="text" id="newsSource" class="write-form__input" placeholder="예: 여수시민신문">
                    </div>
                </div>

                <div class="write-form__section">
                    <label class="write-form__label">원문 링크 (선택)</label>
                    <input type="url" id="newsLink" class="write-form__input" placeholder="https://...">
                </div>

                <div class="write-form__section">
                    <label class="write-form__label">내용 <span class="required">*</span></label>
                    <div class="editor-wrap"><div id="editor"></div></div>
                    <p class="write-form__hint">이미지는 드래그 앤 드롭 또는 Ctrl+V로 추가할 수 있습니다</p>
                </div>

                <div class="write-form__actions">
                    <button type="button" class="btn btn--outline btn--lg" onclick="location.href='news-manage.html'">취소</button>
                    <button type="submit" class="btn btn--primary btn--lg" id="submitBtn">
                        <span class="btn__text">저장하기</span>
                        <span class="btn__loading" style="display: none;">저장 중...</span>
                    </button>
                </div>
            </form>
        </div>
    </main>

    <div class="upload-progress" id="uploadProgress">
        <div style="font-size: 0.875rem; font-weight: 500;">이미지 업로드 중...</div>
    </div>

    <style>
        .write-form { max-width: 1000px; }
        .write-form__section { margin-bottom: 1.5rem; }
        .write-form__section--half { flex: 1; }
        .write-form__row { display: flex; gap: 1.5rem; }
        .write-form__label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-dark); }
        .write-form__label .required { color: #ef4444; }
        .write-form__input, .write-form__select { width: 100%; padding: 0.875rem 1rem; border: 1px solid var(--border-light); border-radius: 0.5rem; font-size: 1rem; }
        .write-form__input:focus, .write-form__select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .write-form__hint { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem; font-size: 0.875rem; color: var(--text-light); }
        .write-form__actions { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-light); }
        .btn--lg { padding: 0.875rem 2rem; font-size: 1rem; }
        .editor-wrap { border: 1px solid var(--border-light); border-radius: 0.5rem; overflow: hidden; }
        .toastui-editor-defaultUI { border: none !important; }
        .upload-progress { position: fixed; bottom: 2rem; right: 2rem; background: #fff; border-radius: 0.75rem; box-shadow: 0 10px 40px rgba(0,0,0,0.15); padding: 1rem 1.5rem; display: none; z-index: 1000; }
        .upload-progress.show { display: block; }
        @media (max-width: 768px) { .write-form__row { flex-direction: column; gap: 1rem; } }
    </style>

    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, addDoc, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCnMM7eMXjZgjP-dovTJ-cfH7iO5RWQnno",
            authDomain: "seopung-website.firebaseapp.com",
            projectId: "seopung-website",
            storageBucket: "seopung-website.firebasestorage.app",
            messagingSenderId: "563395096680",
            appId: "1:563395096680:web:8f363c42f6833f65628bdd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let editor = null;
        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('id');

        function compressImage(blob, maxWidth = 1200, quality = 0.8) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width, height = img.height;
                    if (width > maxWidth) { height = Math.round((height * maxWidth) / width); width = maxWidth; }
                    canvas.width = width; canvas.height = height;
                    canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                    canvas.toBlob((b) => resolve(b || blob), 'image/jpeg', quality);
                };
                img.onerror = () => resolve(blob);
                img.src = URL.createObjectURL(blob);
            });
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        async function uploadImage(blob) {
            const progress = document.getElementById('uploadProgress');
            progress.classList.add('show');
            try {
                const compressed = await compressImage(blob, 1200, 0.8);
                const fileName = `news/${Date.now()}_${Math.random().toString(36).substr(2,9)}.jpg`;
                const storageRef = ref(storage, fileName);
                const task = uploadBytesResumable(storageRef, compressed);
                const url = await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => reject(new Error('Timeout')), 15000);
                    task.on('state_changed', null, reject, async () => {
                        clearTimeout(timeout);
                        resolve(await getDownloadURL(task.snapshot.ref));
                    });
                });
                progress.classList.remove('show');
                return url;
            } catch (e) {
                console.error('Upload failed, using base64:', e);
                const compressed = await compressImage(blob, 800, 0.7);
                const base64 = await blobToBase64(compressed);
                progress.classList.remove('show');
                return base64;
            }
        }

        function initEditor() {
            editor = new toastui.Editor({
                el: document.querySelector('#editor'),
                height: '500px',
                initialEditType: 'wysiwyg',
                previewStyle: 'vertical',
                language: 'ko-KR',
                placeholder: '뉴스 내용을 입력하세요...',
                toolbarItems: [['heading', 'bold', 'italic', 'strike'], ['hr', 'quote'], ['ul', 'ol', 'task'], ['table', 'image', 'link'], ['code', 'codeblock']],
                hooks: {
                    addImageBlobHook: (blob, callback) => {
                        (async () => {
                            try {
                                const url = await uploadImage(blob);
                                callback(url, '이미지');
                            } catch (e) {
                                try { callback(await blobToBase64(blob), '이미지'); } catch (e2) { alert('이미지 추가 실패'); }
                            }
                        })();
                        return false;
                    }
                }
            });
        }

        async function loadNews() {
            if (!editId) return;
            document.getElementById('pageTitle').textContent = '뉴스 수정';
            try {
                const snap = await getDoc(doc(db, "news", editId));
                if (snap.exists()) {
                    const data = snap.data();
                    document.getElementById('newsTitle').value = data.title || '';
                    document.getElementById('newsCategory').value = data.category || '언론보도';
                    document.getElementById('newsSource').value = data.source || '';
                    document.getElementById('newsLink').value = data.link || '';
                    setTimeout(() => { if (editor && data.content) editor.setHTML(data.content); }, 100);
                } else {
                    alert('뉴스를 찾을 수 없습니다.');
                    location.href = 'news-manage.html';
                }
            } catch (e) { console.error(e); alert('데이터를 불러올 수 없습니다.'); }
        }

        async function saveNews(e) {
            e.preventDefault();
            const title = document.getElementById('newsTitle').value.trim();
            const content = editor.getHTML();
            const category = document.getElementById('newsCategory').value;
            const source = document.getElementById('newsSource').value.trim();
            const link = document.getElementById('newsLink').value.trim();

            if (!title) { alert('제목을 입력해주세요.'); return; }
            if (!content || content === '<p><br></p>') { alert('내용을 입력해주세요.'); return; }

            const btn = document.getElementById('submitBtn');
            btn.querySelector('.btn__text').style.display = 'none';
            btn.querySelector('.btn__loading').style.display = 'inline';
            btn.disabled = true;

            try {
                if (editId) {
                    await updateDoc(doc(db, "news", editId), { title, content, category, source, link, updatedAt: Timestamp.now() });
                    alert('뉴스가 수정되었습니다.');
                } else {
                    await addDoc(collection(db, "news"), { title, content, category, source, link, views: 0, createdAt: Timestamp.now() });
                    alert('뉴스가 등록되었습니다.');
                }
                location.href = 'news-manage.html';
            } catch (e) {
                console.error(e);
                alert('저장에 실패했습니다.');
                btn.querySelector('.btn__text').style.display = 'inline';
                btn.querySelector('.btn__loading').style.display = 'none';
                btn.disabled = false;
            }
        }

        const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true' || sessionStorage.getItem('adminLoggedIn') === 'true';
        if (!isLoggedIn) window.location.href = 'index.html';

        window.logout = function() {
            localStorage.removeItem('adminLoggedIn'); localStorage.removeItem('adminUser'); localStorage.removeItem('loginTime');
            sessionStorage.clear();
            window.location.href = 'index.html';
        };

        initEditor();
        loadNews();
        document.getElementById('newsForm').addEventListener('submit', saveNews);
    </script>
</body>
</html>
