<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 대시보드 | 서풍</title>
    <meta name="robots" content="noindex, nofollow">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>
<body class="admin-page">
    <!-- Admin Sidebar -->
    <aside class="admin-sidebar">
        <div class="admin-sidebar__header">
            <img src="../logo_transparent.png" alt="서풍" class="admin-sidebar__logo">
            <span>서풍 관리자</span>
        </div>

        <nav class="admin-nav">
            <a href="dashboard.html" class="admin-nav__item admin-nav__item--active">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                </svg>
                <span>대시보드</span>
            </a>
            <a href="inquiries.html" class="admin-nav__item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                <span>제품 문의</span>
                <span class="admin-nav__badge" id="navInquiryBadge">0</span>
            </a>
            <a href="quotes.html" class="admin-nav__item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                <span>견적 요청</span>
                <span class="admin-nav__badge" id="navQuoteBadge">0</span>
            </a>
            <a href="account-info.html" class="admin-nav__item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                <span>접속 정보</span>
            </a>
        </nav>

        <div class="admin-sidebar__footer">
            <a href="../index.html" class="admin-sidebar__link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                    <polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/>
                </svg>
                <span>홈페이지 보기</span>
            </a>
            <button class="admin-sidebar__logout" onclick="logout()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                <span>로그아웃</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <header class="admin-header">
            <div class="admin-header__title">
                <h1>대시보드</h1>
                <p>서풍 홈페이지 관리 현황</p>
            </div>
            <div class="admin-header__user">
                <span id="currentUser">관리자</span>
                <span id="loginTime"></span>
            </div>
        </header>

        <div class="admin-content">
            <!-- Firebase 설정 안내 -->
            <div id="firebaseNotice" class="admin-card" style="margin-bottom: 1.5rem; background: #fef3c7; border: 1px solid #f59e0b; display: none;">
                <div class="admin-card__content" style="padding: 1rem 1.5rem;">
                    <p style="margin: 0; color: #92400e;">
                        <strong>Firebase 설정 필요:</strong> 문의/견적 기능을 사용하려면 Firebase를 설정해야 합니다.
                        <a href="firebase-setup.html" style="color: #d97706; text-decoration: underline;">설정 가이드 보기</a>
                    </p>
                </div>
            </div>

            <!-- 요약 카드 -->
            <div class="admin-stats">
                <div class="admin-stat-card">
                    <div class="admin-stat-card__icon admin-stat-card__icon--blue">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                    </div>
                    <div class="admin-stat-card__content">
                        <span class="admin-stat-card__number" id="inquiryCount">-</span>
                        <span class="admin-stat-card__label">신규 제품 문의</span>
                    </div>
                    <a href="inquiries.html" class="admin-stat-card__link">보기 →</a>
                </div>

                <div class="admin-stat-card">
                    <div class="admin-stat-card__icon admin-stat-card__icon--green">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                    </div>
                    <div class="admin-stat-card__content">
                        <span class="admin-stat-card__number" id="quoteCount">-</span>
                        <span class="admin-stat-card__label">신규 견적 요청</span>
                    </div>
                    <a href="quotes.html" class="admin-stat-card__link">보기 →</a>
                </div>

                <div class="admin-stat-card">
                    <div class="admin-stat-card__icon admin-stat-card__icon--purple">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                    </div>
                    <div class="admin-stat-card__content">
                        <span class="admin-stat-card__number" id="totalInquiries">-</span>
                        <span class="admin-stat-card__label">총 문의</span>
                    </div>
                </div>

                <div class="admin-stat-card">
                    <div class="admin-stat-card__icon admin-stat-card__icon--orange">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 17H2a3 3 0 0 0 3-3V9a7 7 0 0 1 14 0v5a3 3 0 0 0 3 3zm-8.27 4a2 2 0 0 1-3.46 0"/>
                        </svg>
                    </div>
                    <div class="admin-stat-card__content">
                        <span class="admin-stat-card__number" id="totalQuotes">-</span>
                        <span class="admin-stat-card__label">총 견적요청</span>
                    </div>
                </div>
            </div>

            <!-- 최근 문의 & 견적 -->
            <div class="admin-grid">
                <div class="admin-card">
                    <div class="admin-card__header">
                        <h3>최근 제품 문의</h3>
                        <a href="inquiries.html">전체보기 →</a>
                    </div>
                    <div class="admin-card__content">
                        <table class="admin-table">
                            <thead>
                                <tr><th>회사명</th><th>문의유형</th><th>날짜</th><th>상태</th></tr>
                            </thead>
                            <tbody id="inquiriesTableBody">
                                <tr><td colspan="4" style="text-align: center;">로딩 중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="admin-card">
                    <div class="admin-card__header">
                        <h3>최근 견적 요청</h3>
                        <a href="quotes.html">전체보기 →</a>
                    </div>
                    <div class="admin-card__content">
                        <table class="admin-table">
                            <thead>
                                <tr><th>회사명</th><th>제품</th><th>물량</th><th>상태</th></tr>
                            </thead>
                            <tbody id="quotesTableBody">
                                <tr><td colspan="4" style="text-align: center;">로딩 중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 빠른 작업 -->
            <div class="admin-card">
                <div class="admin-card__header">
                    <h3>빠른 작업</h3>
                </div>
                <div class="admin-card__content">
                    <div class="admin-quick-actions">
                        <a href="../board/inquiry.html" class="admin-quick-action" target="_blank">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                <polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/>
                            </svg>
                            문의 페이지 보기
                        </a>
                        <a href="../board/quote.html" class="admin-quick-action" target="_blank">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                            </svg>
                            견적 페이지 보기
                        </a>
                        <a href="firebase-setup.html" class="admin-quick-action">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M12 1v6m0 6v6m-9-9h6m6 0h6"/>
                            </svg>
                            Firebase 설정
                        </a>
                        <a href="account-info.html" class="admin-quick-action">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                            접속 정보 확인
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyCnMM7eMXjZgjP-dovTJ-cfH7iO5RWQnno",
            authDomain: "seopung-website.firebaseapp.com",
            projectId: "seopung-website",
            storageBucket: "seopung-website.firebasestorage.app",
            messagingSenderId: "563395096680",
            appId: "1:563395096680:web:8f363c42f6833f65628bdd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const typeMap = { 'product': '제품문의', 'sample': '샘플요청', 'trade': '거래조건', 'other': '기타' };
        const productNames = { 'mackerel': '간고등어', 'squid': '오징어', 'seabream': '참돔', 'salmon': '연어', 'flatfish': '광어/우럭' };
        const statusMap = { 'pending': '대기', 'progress': '검토중', 'completed': '완료' };
        const statusClassMap = { 'pending': 'admin-badge--pending', 'progress': 'admin-badge--progress', 'completed': 'admin-badge--completed' };

        function formatDate(timestamp) {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return `${date.getFullYear()}.${String(date.getMonth()+1).padStart(2,'0')}.${String(date.getDate()).padStart(2,'0')}`;
        }

        async function loadDashboard() {
            try {
                // 문의 로드
                const inquiriesQuery = query(collection(db, "inquiries"), orderBy("createdAt", "desc"));
                const inquiriesSnap = await getDocs(inquiriesQuery);
                const inquiries = [];
                inquiriesSnap.forEach(doc => inquiries.push({ id: doc.id, ...doc.data() }));

                // 견적 로드
                const quotesQuery = query(collection(db, "quotes"), orderBy("createdAt", "desc"));
                const quotesSnap = await getDocs(quotesQuery);
                const quotes = [];
                quotesSnap.forEach(doc => quotes.push({ id: doc.id, ...doc.data() }));

                // 통계 업데이트
                const pendingInquiries = inquiries.filter(i => i.status === 'pending').length;
                const pendingQuotes = quotes.filter(q => q.status === 'pending').length;

                document.getElementById('inquiryCount').textContent = pendingInquiries;
                document.getElementById('quoteCount').textContent = pendingQuotes;
                document.getElementById('totalInquiries').textContent = inquiries.length;
                document.getElementById('totalQuotes').textContent = quotes.length;
                document.getElementById('navInquiryBadge').textContent = pendingInquiries;
                document.getElementById('navQuoteBadge').textContent = pendingQuotes;

                // 최근 문의 테이블
                const inquiriesBody = document.getElementById('inquiriesTableBody');
                if (inquiries.length === 0) {
                    inquiriesBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-light);">문의 내역이 없습니다.</td></tr>';
                } else {
                    inquiriesBody.innerHTML = inquiries.slice(0, 5).map(i => `
                        <tr style="cursor: pointer;" onclick="location.href='inquiries.html'">
                            <td><strong>${i.company || '-'}</strong><br><small>${i.name || '-'}</small></td>
                            <td>${typeMap[i.inquiry_type] || '-'}</td>
                            <td>${formatDate(i.createdAt)}</td>
                            <td><span class="admin-badge ${statusClassMap[i.status] || 'admin-badge--pending'}">${statusMap[i.status] || '-'}</span></td>
                        </tr>
                    `).join('');
                }

                // 최근 견적 테이블
                const quotesBody = document.getElementById('quotesTableBody');
                if (quotes.length === 0) {
                    quotesBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-light);">견적 요청 내역이 없습니다.</td></tr>';
                } else {
                    quotesBody.innerHTML = quotes.slice(0, 5).map(q => {
                        const products = q.products ? q.products.slice(0, 2).map(p => productNames[p] || p).join(', ') : '-';
                        return `
                            <tr style="cursor: pointer;" onclick="location.href='quotes.html'">
                                <td><strong>${q.company || '-'}</strong><br><small>${q.name || '-'}</small></td>
                                <td>${products}</td>
                                <td>${q.quantity || '-'}</td>
                                <td><span class="admin-badge ${statusClassMap[q.status] || 'admin-badge--pending'}">${statusMap[q.status] || '-'}</span></td>
                            </tr>
                        `;
                    }).join('');
                }

            } catch (error) {
                console.error("Firebase Error:", error);
                document.getElementById('firebaseNotice').style.display = 'block';
                document.getElementById('inquiryCount').textContent = '-';
                document.getElementById('quoteCount').textContent = '-';
                document.getElementById('totalInquiries').textContent = '-';
                document.getElementById('totalQuotes').textContent = '-';
                document.getElementById('inquiriesTableBody').innerHTML = '<tr><td colspan="4" style="text-align: center; color: #ef4444;">Firebase 연결 실패</td></tr>';
                document.getElementById('quotesTableBody').innerHTML = '<tr><td colspan="4" style="text-align: center; color: #ef4444;">Firebase 연결 실패</td></tr>';
            }
        }

        // 로그인 체크
        if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
            window.location.href = 'index.html';
        }

        document.getElementById('currentUser').textContent = sessionStorage.getItem('adminUser') || '관리자';
        const loginTime = sessionStorage.getItem('loginTime');
        if (loginTime) {
            const date = new Date(loginTime);
            document.getElementById('loginTime').textContent = `로그인: ${date.toLocaleDateString('ko-KR')} ${date.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'})}`;
        }

        window.logout = function() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        };

        // 초기 로드
        loadDashboard();
    </script>
</body>
</html>
