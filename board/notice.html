<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>공지사항 | 서풍</title>
    <meta name="description" content="서풍 공지사항 - 회사 소식, 휴무일 안내">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <link rel="stylesheet" href="../css/board.css">
</head>
<body>
    <!-- Header -->
    <header class="header" id="header">
        <div class="header__container">
            <a href="../index.html" class="logo">
                <div class="logo__icon">
                    <img src="../logo_transparent.png" alt="서풍 로고">
                </div>
                <div class="logo__text">
                    <span class="logo__main">서풍</span>
                    <span class="logo__sub">SEOPOONG</span>
                </div>
            </a>

            <nav class="nav">
                <ul class="nav__list" id="navList">
                    <li><a href="../index.html" class="nav__link">홈</a></li>
                    <li><a href="../about.html" class="nav__link">회사소개</a></li>
                    <li><a href="../process.html" class="nav__link">가공 프로세스</a></li>
                    <li><a href="../products.html" class="nav__link">제품</a></li>
                    <li><a href="../gallery.html" class="nav__link">갤러리</a></li>
                    <li><a href="../board.html" class="nav__link nav__link--active">게시판</a></li>
                    <li><a href="../contact.html" class="nav__link nav__link--cta">문의하기</a></li>
                </ul>
                <button class="nav__toggle" id="navToggle" aria-label="메뉴 열기">
                    <span class="nav__toggle-bar"></span>
                    <span class="nav__toggle-bar"></span>
                    <span class="nav__toggle-bar"></span>
                </button>
            </nav>
        </div>
    </header>

    <!-- Page Header -->
    <section class="page-header">
        <div class="page-header__content">
            <span class="page-header__tag">NOTICE</span>
            <h1 class="page-header__title">공지사항</h1>
            <p class="page-header__desc">서풍의 주요 소식과 안내사항을 확인하세요</p>
        </div>
    </section>

    <!-- Board List Section -->
    <section class="section">
        <div class="container">
            <!-- Search & Filter -->
            <div class="board-toolbar">
                <div class="board-filter">
                    <button class="board-filter__btn board-filter__btn--active" onclick="filterCategory('all')">전체</button>
                    <button class="board-filter__btn" onclick="filterCategory('일반공지')">일반공지</button>
                    <button class="board-filter__btn" onclick="filterCategory('휴무안내')">휴무안내</button>
                    <button class="board-filter__btn" onclick="filterCategory('제품안내')">제품안내</button>
                </div>
                <div class="board-search">
                    <input type="text" class="board-search__input" id="searchInput" placeholder="검색어를 입력하세요" onkeypress="if(event.key==='Enter') searchNotices()">
                    <button class="board-search__btn" onclick="searchNotices()">검색</button>
                </div>
            </div>

            <!-- Board List -->
            <div class="board-list">
                <div class="board-list__header">
                    <span>번호</span>
                    <span>제목</span>
                    <span>등록일</span>
                    <span>조회</span>
                </div>
                <div id="noticeList">
                    <div class="board-list__item" style="justify-content: center; color: var(--text-light);">
                        로딩 중...
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="pagination"></div>
        </div>
    </section>

    <!-- Notice Detail Modal -->
    <div id="detailModal" class="notice-modal" style="display: none;">
        <div class="notice-modal__content">
            <div class="notice-modal__header">
                <h3 id="modalTitle">공지사항</h3>
                <button class="notice-modal__close" onclick="closeModal()">&times;</button>
            </div>
            <div class="notice-modal__meta">
                <span id="modalCategory"></span>
                <span id="modalDate"></span>
                <span id="modalViews"></span>
            </div>
            <div class="notice-modal__body" id="modalBody"></div>
            <div class="notice-modal__footer">
                <button class="btn btn--outline" onclick="closeModal()">닫기</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer__container">
            <div class="footer__grid">
                <div class="footer__brand">
                    <h3 class="footer__brand-title">서풍</h3>
                    <p class="footer__brand-desc">
                        신뢰로써 공존하는 기업<br>
                        50년 경력의 베테랑이 가진 '선별의 눈'과 최신 가공 시설로<br>
                        가장 신선하고 안전한 수산물을 공급합니다.
                    </p>
                </div>
                <div class="footer__links">
                    <h4 class="footer__title">바로가기</h4>
                    <ul>
                        <li><a href="../about.html">회사소개</a></li>
                        <li><a href="../process.html">가공 프로세스</a></li>
                        <li><a href="../products.html">제품</a></li>
                        <li><a href="../gallery.html">갤러리</a></li>
                    </ul>
                </div>
                <div class="footer__links">
                    <h4 class="footer__title">게시판</h4>
                    <ul>
                        <li><a href="notice.html">공지사항</a></li>
                        <li><a href="resources.html">자료실</a></li>
                        <li><a href="inquiry.html">제품 문의</a></li>
                        <li><a href="quote.html">견적 요청</a></li>
                    </ul>
                </div>
                <div class="footer__links">
                    <h4 class="footer__title">연락처</h4>
                    <ul>
                        <li><a href="tel:061-681-5171">061-681-5171</a></li>
                        <li>FAX 061-681-5173</li>
                        <li><a href="../contact.html">전남 여수시 화양면 석교로 121</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer__bottom">
                <p>&copy; 2024 영어조합법인 서풍. All rights reserved.</p>
                <p>사업자등록번호: 417-81-41979 | 대표: 서순심 | 평일 09:00 - 18:00 | <a href="../admin/" style="color: var(--text-muted);">관리자</a></p>
            </div>
        </div>
    </footer>

    <style>
        .notice-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .notice-modal__content { background: #fff; border-radius: 1rem; width: 100%; max-width: 700px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; }
        .notice-modal__header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border-light); }
        .notice-modal__header h3 { font-size: 1.25rem; font-weight: 600; color: var(--text-dark); }
        .notice-modal__close { background: none; border: none; font-size: 1.75rem; cursor: pointer; color: var(--text-light); line-height: 1; }
        .notice-modal__meta { display: flex; gap: 1rem; padding: 1rem 1.5rem; background: var(--bg-light); font-size: 0.875rem; color: var(--text-light); }
        .notice-modal__body { padding: 1.5rem; overflow-y: auto; flex: 1; line-height: 1.8; }
        .notice-modal__body h1, .notice-modal__body h2, .notice-modal__body h3, .notice-modal__body h4 { margin: 1rem 0 0.5rem; font-weight: 600; }
        .notice-modal__body h1 { font-size: 1.5rem; }
        .notice-modal__body h2 { font-size: 1.25rem; }
        .notice-modal__body h3 { font-size: 1.1rem; }
        .notice-modal__body p { margin: 0.5rem 0; }
        .notice-modal__body ul, .notice-modal__body ol { margin: 0.5rem 0; padding-left: 1.5rem; }
        .notice-modal__body li { margin: 0.25rem 0; }
        .notice-modal__body img { max-width: 100%; height: auto; border-radius: 0.5rem; margin: 1rem 0; }
        .notice-modal__body blockquote { border-left: 4px solid var(--primary); padding-left: 1rem; margin: 1rem 0; color: var(--text-light); background: var(--bg-light); padding: 1rem; border-radius: 0 0.5rem 0.5rem 0; }
        .notice-modal__body pre { background: #1e1e1e; color: #fff; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 1rem 0; }
        .notice-modal__body code { background: var(--bg-light); padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-family: monospace; }
        .notice-modal__body pre code { background: none; padding: 0; }
        .notice-modal__body table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        .notice-modal__body th, .notice-modal__body td { border: 1px solid var(--border-light); padding: 0.5rem; text-align: left; }
        .notice-modal__body th { background: var(--bg-light); font-weight: 600; }
        .notice-modal__body hr { border: none; border-top: 1px solid var(--border-light); margin: 1.5rem 0; }
        .notice-modal__body a { color: var(--primary); text-decoration: underline; }
        .notice-modal__footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border-light); display: flex; justify-content: flex-end; }
    </style>

    <script src="../js/main.js"></script>
    <script src="../js/navigation.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, increment, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCnMM7eMXjZgjP-dovTJ-cfH7iO5RWQnno",
            authDomain: "seopung-website.firebaseapp.com",
            projectId: "seopung-website",
            storageBucket: "seopung-website.firebasestorage.app",
            messagingSenderId: "563395096680",
            appId: "1:563395096680:web:8f363c42f6833f65628bdd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let noticesData = [];
        let filteredData = [];
        let currentCategory = 'all';
        let currentPage = 1;
        const itemsPerPage = 10;

        function formatDate(timestamp) {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return `${date.getFullYear()}.${String(date.getMonth()+1).padStart(2,'0')}.${String(date.getDate()).padStart(2,'0')}`;
        }

        function isNew(timestamp) {
            if (!timestamp) return false;
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const diff = Date.now() - date.getTime();
            return diff < 7 * 24 * 60 * 60 * 1000; // 7일 이내
        }

        async function loadNotices() {
            try {
                const q = query(collection(db, "notices"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                noticesData = [];
                querySnapshot.forEach((doc) => {
                    noticesData.push({ id: doc.id, ...doc.data() });
                });

                // 고정 공지를 상단으로
                noticesData.sort((a, b) => {
                    if (a.pinned && !b.pinned) return -1;
                    if (!a.pinned && b.pinned) return 1;
                    return 0;
                });

                filteredData = [...noticesData];
                renderNotices();
            } catch (error) {
                console.error("Error loading notices:", error);
                document.getElementById('noticeList').innerHTML = `
                    <div class="board-list__item" style="justify-content: center; color: var(--text-light);">
                        공지사항을 불러올 수 없습니다.
                    </div>
                `;
            }
        }

        function renderNotices() {
            const container = document.getElementById('noticeList');
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            if (pageData.length === 0) {
                container.innerHTML = `
                    <div class="board-list__item" style="justify-content: center; color: var(--text-light);">
                        등록된 공지사항이 없습니다.
                    </div>
                `;
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            container.innerHTML = pageData.map((notice, idx) => {
                const num = notice.pinned ? '<span class="board-list__num--notice">공지</span>' : (filteredData.length - start - idx);
                const newBadge = isNew(notice.createdAt) ? '<span class="board-list__new">N</span>' : '';

                return `
                    <div class="board-list__item ${notice.pinned ? 'board-list__item--notice' : ''}" onclick="openNotice('${notice.id}')" style="cursor: pointer;">
                        <span class="board-list__num">${num}</span>
                        <div class="board-list__title">
                            <a href="#">${notice.title || '(제목 없음)'}</a>
                            ${newBadge}
                        </div>
                        <span class="board-list__date">${formatDate(notice.createdAt)}</span>
                        <span class="board-list__views">${notice.views || 0}</span>
                    </div>
                `;
            }).join('');

            renderPagination();
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (totalPages <= 1) {
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            let html = '';
            html += `<button class="pagination__btn ${currentPage === 1 ? 'pagination__btn--disabled' : ''}" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"/>
                </svg>
            </button>`;

            for (let i = 1; i <= totalPages; i++) {
                html += `<button class="pagination__btn ${currentPage === i ? 'pagination__btn--active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }

            html += `<button class="pagination__btn ${currentPage === totalPages ? 'pagination__btn--disabled' : ''}" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"/>
                </svg>
            </button>`;

            document.getElementById('pagination').innerHTML = html;
        }

        window.goToPage = function(page) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderNotices();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.filterCategory = function(category) {
            currentCategory = category;
            currentPage = 1;

            document.querySelectorAll('.board-filter__btn').forEach(btn => btn.classList.remove('board-filter__btn--active'));
            event.target.classList.add('board-filter__btn--active');

            if (category === 'all') {
                filteredData = [...noticesData];
            } else {
                filteredData = noticesData.filter(n => n.category === category);
            }
            renderNotices();
        };

        window.searchNotices = function() {
            const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
            currentPage = 1;

            if (!keyword) {
                filteredData = currentCategory === 'all' ? [...noticesData] : noticesData.filter(n => n.category === currentCategory);
            } else {
                filteredData = noticesData.filter(n => {
                    const matchCategory = currentCategory === 'all' || n.category === currentCategory;
                    const matchKeyword = (n.title && n.title.toLowerCase().includes(keyword)) ||
                                        (n.content && n.content.toLowerCase().includes(keyword));
                    return matchCategory && matchKeyword;
                });
            }
            renderNotices();
        };

        window.openNotice = async function(id) {
            const notice = noticesData.find(n => n.id === id);
            if (!notice) return;

            // 조회수 증가
            try {
                await updateDoc(doc(db, "notices", id), { views: increment(1) });
                notice.views = (notice.views || 0) + 1;
            } catch (e) { console.error(e); }

            document.getElementById('modalTitle').textContent = notice.title || '공지사항';
            document.getElementById('modalCategory').textContent = notice.category || '일반공지';
            document.getElementById('modalDate').textContent = formatDate(notice.createdAt);
            document.getElementById('modalViews').textContent = `조회 ${notice.views || 0}`;
            document.getElementById('modalBody').innerHTML = notice.content || '';
            document.getElementById('detailModal').style.display = 'flex';
        };

        window.closeModal = function() {
            document.getElementById('detailModal').style.display = 'none';
            renderNotices(); // 조회수 반영
        };

        document.getElementById('detailModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // 초기 로드
        loadNotices();
    </script>
</body>
</html>
